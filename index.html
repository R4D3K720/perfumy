import React, { useEffect, useMemo, useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger } from "@/components/ui/sheet";
import { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { toast } from "sonner";
import { motion, AnimatePresence } from "framer-motion";
import { ShoppingCart, Search, X, Star, ChevronDown, Trash2, Plus, Minus, Filter } from "lucide-react";

// --- Utils ---
const formatPLN = (n) => new Intl.NumberFormat("pl-PL", { style: "currency", currency: "PLN" }).format(n);
const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

// --- Demo catalog ---
const PRODUCTS = [
  {
    id: "sauvage-edt",
    name: "Dior Sauvage EDT",
    brand: "Dior",
    gender: "męskie",
    family: "aromatyczno-fougere",
    notes: ["bergamotka", "pieprz", "ambra"],
    rating: 4.7,
    price: 449,
    oldPrice: 499,
    ml: [60, 100, 200],
    image: "https://images.unsplash.com/photo-1629196900384-2c0db83b6f39?q=80&w=1200&auto=format&fit=crop",
    bestseller: true,
  },
  {
    id: "bleu-edp",
    name: "Bleu de Chanel EDP",
    brand: "Chanel",
    gender: "męskie",
    family: "drzewno-aromatyczne",
    notes: ["cytrusy", "kadzidło", "drzewo sandałowe"],
    rating: 4.8,
    price: 599,
    ml: [50, 100, 150],
    image: "https://images.unsplash.com/photo-1629196900991-e1c78c73d972?q=80&w=1200&auto=format&fit=crop",
    bestseller: true,
  },
  {
    id: "aventus",
    name: "Creed Aventus",
    brand: "Creed",
    gender: "męskie",
    family: "owocowo-drzewne",
    notes: ["ananas", "brzoza", "piżmo"],
    rating: 4.6,
    price: 1390,
    ml: [50, 100],
    image: "https://images.unsplash.com/photo-1603714228681-8d7b9b3db504?q=80&w=1200&auto=format&fit=crop",
    bestseller: true,
  },
  {
    id: "br540",
    name: "Baccarat Rouge 540 EDP",
    brand: "MFK",
    gender: "unisex",
    family: "bursztynowo-kwiatowe",
    notes: ["ambra", "szafran", "cedr"],
    rating: 4.7,
    price: 1190,
    ml: [35, 70],
    image: "https://images.unsplash.com/photo-1612815154858-60aa4c59eaa0?q=80&w=1200&auto=format&fit=crop",
  },
  {
    id: "black-orchid",
    name: "Tom Ford Black Orchid",
    brand: "Tom Ford",
    gender: "unisex",
    family: "orientalno-kwiatowe",
    notes: ["czarna orchidea", "trufla", "paczula"],
    rating: 4.5,
    price: 589,
    ml: [50, 100],
    image: "https://images.unsplash.com/photo-1621242160078-75e67e1bb9e1?q=80&w=1200&auto=format&fit=crop",
  },
  {
    id: "good-girl",
    name: "Carolina Herrera Good Girl",
    brand: "Carolina Herrera",
    gender: "damskie",
    family: "bursztynowo-kwiatowe",
    notes: ["jaśmin", "kakao", "tonka"],
    rating: 4.4,
    price: 439,
    ml: [50, 80],
    image: "https://images.unsplash.com/photo-1608571425184-1a90b88f0f20?q=80&w=1200&auto=format&fit=crop",
  },
  {
    id: "j-adore",
    name: "Dior J'adore",
    brand: "Dior",
    gender: "damskie",
    family: "kwiatowe",
    notes: ["ylang-ylang", "jaśmin", "róża"],
    rating: 4.6,
    price: 549,
    ml: [50, 100],
    image: "https://images.unsplash.com/photo-1556228724-4b9d1a0639f6?q=80&w=1200&auto=format&fit=crop",
  },
  {
    id: "no5",
    name: "Chanel No. 5",
    brand: "Chanel",
    gender: "damskie",
    family: "kwiatowo-aldehydowe",
    notes: ["aldehydy", "ylang-ylang", "piżmo"],
    rating: 4.7,
    price: 699,
    ml: [50, 100],
    image: "https://images.unsplash.com/photo-1585386959984-a4155223168f?q=80&w=1200&auto=format&fit=crop",
  },
  {
    id: "acqua-di-gio",
    name: "Giorgio Armani Acqua di Giò",
    brand: "Armani",
    gender: "męskie",
    family: "cytrusowo-wodne",
    notes: ["limonka", "jaśmin", "morska bryza"],
    rating: 4.3,
    price: 389,
    ml: [50, 100, 200],
    image: "https://images.unsplash.com/photo-1563170351-be82bc888aa4?q=80&w=1200&auto=format&fit=crop",
  },
  {
    id: "la-nuit",
    name: "YSL La Nuit de L'Homme",
    brand: "YSL",
    gender: "męskie",
    family: "przyprawowe",
    notes: ["kardamon", "lawenda", "cedr"],
    rating: 4.4,
    price: 439,
    ml: [60, 100],
    image: "https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&w=1200&auto=format&fit=crop",
  },
];

export default function PerfumeShop() {
  // --- UI state ---
  const [query, setQuery] = useState("");
  const [gender, setGender] = useState("wszyscy");
  const [brand, setBrand] = useState("wszyscy");
  const [family, setFamily] = useState("wszystkie");
  const [sort, setSort] = useState("popular");
  const [priceMax, setPriceMax] = useState(1500);
  const [openCart, setOpenCart] = useState(false);
  const [quickView, setQuickView] = useState(null);

  // --- Cart state ---
  const [cart, setCart] = useState(() => {
    try {
      const raw = localStorage.getItem("perfume_cart_v1");
      return raw ? JSON.parse(raw) : [];
    } catch {
      return [];
    }
  });

  useEffect(() => {
    localStorage.setItem("perfume_cart_v1", JSON.stringify(cart));
  }, [cart]);

  const brands = useMemo(() => ["wszyscy", ...Array.from(new Set(PRODUCTS.map(p => p.brand)))], []);
  const families = useMemo(() => ["wszystkie", ...Array.from(new Set(PRODUCTS.map(p => p.family)))], []);

  const filtered = useMemo(() => {
    let out = PRODUCTS.filter(p => p.price <= priceMax);
    if (gender !== "wszyscy") out = out.filter(p => p.gender === gender);
    if (brand !== "wszyscy") out = out.filter(p => p.brand === brand);
    if (family !== "wszystkie") out = out.filter(p => p.family === family);
    if (query.trim()) {
      const q = query.toLowerCase();
      out = out.filter(p => `${p.name} ${p.brand} ${p.family} ${p.notes.join(" ")}`.toLowerCase().includes(q));
    }
    switch (sort) {
      case "price-asc": out.sort((a,b)=>a.price-b.price); break;
      case "price-desc": out.sort((a,b)=>b.price-a.price); break;
      case "rating": out.sort((a,b)=>b.rating-a.rating); break;
      default: out.sort((a,b)=> (b.bestseller?1:0) - (a.bestseller?1:0));
    }
    return out;
  }, [query, gender, brand, family, sort, priceMax]);

  const cartCount = cart.reduce((s,i)=>s+i.qty,0);
  const cartTotal = cart.reduce((s,i)=>s+i.price*i.qty,0);

  const addToCart = (product, sizeMl) => {
    const key = `${product.id}-${sizeMl}`;
    setCart(prev => {
      const existing = prev.find(i => i.key === key);
      if (existing) {
        return prev.map(i => i.key===key?{...i, qty: clamp(i.qty+1,1,99)}:i);
      }
      toast.success("Dodano do koszyka");
      return [...prev, { key, id: product.id, name: product.name, sizeMl, price: product.price * (sizeMl / product.ml[0]), qty: 1, image: product.image }];
    });
  };

  const updateQty = (key, delta) => {
    setCart(prev => prev.map(i => i.key===key?{...i, qty: clamp(i.qty+delta, 1, 99)}:i));
  };

  const removeItem = (key) => setCart(prev => prev.filter(i => i.key!==key));
  const clearCart = () => setCart([]);

  // --- Checkout ---
  const [checkoutOpen, setCheckoutOpen] = useState(false);
  const [customer, setCustomer] = useState({ name: "", email: "", address: "", city: "", zip: "" });

  const placeOrder = () => {
    if (!customer.name || !customer.email || !customer.address) {
      toast.error("Uzupełnij dane do wysyłki");
      return;
    }
    const orderNo = Math.random().toString(36).slice(2,10).toUpperCase();
    toast.success(`Zamówienie #${orderNo} złożone! (symulacja)`);
    setCheckoutOpen(false);
    setOpenCart(false);
    clearCart();
  };

  // --- Component helpers ---
  function ProductCard({ p }) {
    const [size, setSize] = useState(p.ml[0]);
    return (
      <motion.div layout initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="">
        <Card className="overflow-hidden hover:shadow-xl transition-all rounded-2xl">
          <div className="aspect-[4/5] w-full relative overflow-hidden">
            <img src={p.image} alt={p.name} className="object-cover w-full h-full" />
            {p.bestseller && (
              <Badge className="absolute top-3 left-3">Bestseller</Badge>
            )}
            <button onClick={()=>setQuickView(p)} className="absolute bottom-3 right-3 backdrop-blur px-3 py-1 rounded-full text-xs border hover:scale-105 transition">Szybki podgląd</button>
          </div>
          <CardContent className="p-4 space-y-3">
            <div className="flex items-start justify-between gap-3">
              <div>
                <h3 className="font-semibold leading-tight">{p.name}</h3>
                <p className="text-sm text-muted-foreground">{p.brand} • {p.gender}</p>
              </div>
              <div className="flex items-center gap-1 text-sm" aria-label={`Ocena ${p.rating}`}>
                <Star className="w-4 h-4 fill-current" /> {p.rating}
              </div>
            </div>
            <div className="flex items-center gap-2">
              <Select value={String(size)} onValueChange={(v)=>setSize(Number(v))}>
                <SelectTrigger className="w-[140px]"><SelectValue placeholder="Pojemność" /></SelectTrigger>
                <SelectContent>
                  {p.ml.map(m => (
                    <SelectItem key={m} value={String(m)}>{m} ml</SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <div className="ml-auto text-right">
                <div className="text-lg font-semibold">{formatPLN(p.price * (size / p.ml[0]))}</div>
                {p.oldPrice && <div className="text-sm line-through text-muted-foreground">{formatPLN(p.oldPrice)}</div>}
              </div>
            </div>
            <Button className="w-full" onClick={()=>addToCart(p, size)}>
              <ShoppingCart className="w-4 h-4 mr-2"/> Dodaj do koszyka
            </Button>
          </CardContent>
        </Card>
      </motion.div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-white to-slate-50">
      {/* Header */}
      <header className="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/70 bg-white/80 border-b">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
          <div className="flex items-center gap-2">
            <div className="w-9 h-9 rounded-2xl bg-black text-white grid place-items-center font-bold">P</div>
            <div>
              <div className="text-sm uppercase tracking-widest">Perfumeria</div>
              <div className="font-semibold -mt-1">Elegant Scents</div>
            </div>
          </div>

          {/* Search */}
          <div className="hidden md:flex items-center gap-2 ml-6 flex-1">
            <div className="relative w-full max-w-xl">
              <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2"/>
              <Input value={query} onChange={(e)=>setQuery(e.target.value)} placeholder="Szukaj po nazwie, marce, nutach..." className="pl-9 rounded-full"/>
            </div>
          </div>

          {/* Cart */}
          <Sheet open={openCart} onOpenChange={setOpenCart}>
            <SheetTrigger asChild>
              <Button variant="outline" className="rounded-full">
                <ShoppingCart className="w-4 h-4 mr-2"/> Koszyk <Badge className="ml-2">{cartCount}</Badge>
              </Button>
            </SheetTrigger>
            <SheetContent className="w-[520px] max-w-[95vw]">
              <SheetHeader>
                <SheetTitle>Twój koszyk</SheetTitle>
              </SheetHeader>
              <div className="mt-6 space-y-4">
                {cart.length===0 && <div className="text-muted-foreground">Koszyk jest pusty.</div>}
                <div className="space-y-4 max-h-[55vh] overflow-auto pr-2">
                  {cart.map(item => (
                    <div key={item.key} className="flex items-center gap-3 border rounded-xl p-3">
                      <img src={item.image} alt="miniatura" className="w-16 h-16 object-cover rounded-lg"/>
                      <div className="flex-1">
                        <div className="font-medium leading-tight">{item.name}</div>
                        <div className="text-sm text-muted-foreground">{item.sizeMl} ml</div>
                        <div className="font-semibold mt-1">{formatPLN(item.price)}</div>
                      </div>
                      <div className="flex items-center gap-2">
                        <Button size="icon" variant="outline" onClick={()=>updateQty(item.key, -1)}><Minus className="w-4 h-4"/></Button>
                        <div className="w-8 text-center">{item.qty}</div>
                        <Button size="icon" variant="outline" onClick={()=>updateQty(item.key, +1)}><Plus className="w-4 h-4"/></Button>
                      </div>
                      <Button size="icon" variant="ghost" onClick={()=>removeItem(item.key)}><Trash2 className="w-4 h-4"/></Button>
                    </div>
                  ))}
                </div>
                <div className="border-t pt-4 space-y-2">
                  <div className="flex justify-between text-sm text-muted-foreground"><span>Produkty</span><span>{formatPLN(cartTotal)}</span></div>
                  <div className="flex justify-between text-sm text-muted-foreground"><span>Dostawa (szac.)</span><span>{cartTotal>500?"0,00 zł":formatPLN(15)}</span></div>
                  <div className="flex justify-between text-base font-semibold"><span>Razem</span><span>{formatPLN(cartTotal + (cartTotal>500?0:15))}</span></div>
                  <div className="flex gap-2 pt-2">
                    <Button variant="outline" className="flex-1" onClick={clearCart}>Wyczyść</Button>
                    <Button className="flex-1" disabled={!cart.length} onClick={()=>setCheckoutOpen(true)}>Przejdź do kasy</Button>
                  </div>
                </div>
              </div>
            </SheetContent>
          </Sheet>
        </div>
      </header>

      {/* Hero */}
      <section className="max-w-7xl mx-auto px-4 py-10">
        <div className="grid md:grid-cols-2 gap-6 items-center">
          <div className="space-y-4">
            <h1 className="text-3xl md:text-5xl font-bold leading-tight">Luksusowe perfumy 1:1 oraz oryginały – wyraź siebie zapachem</h1>
            <p className="text-muted-foreground text-lg">Sklep stworzony z myślą o czytelności i komforcie zakupów. Filtry, wyszukiwarka, szybki podgląd, koszyk i zamówienie – wszystko w jednym miejscu.</p>
            <div className="flex gap-2">
              <a href="#catalog"><Button>Przeglądaj nowości</Button></a>
              <Button variant="outline">Program lojalnościowy</Button>
            </div>
            <ul className="text-sm text-muted-foreground grid grid-cols-2 gap-2 pt-2">
              <li>• Darmowa dostawa od 500 zł</li>
              <li>• Bezpieczne płatności (symulacja)</li>
              <li>• Zwrot 30 dni</li>
              <li>• Dostępne inspiracje 1:1</li>
            </ul>
          </div>
          <div className="rounded-3xl overflow-hidden shadow-xl">
            <img src="https://images.unsplash.com/photo-1523292562811-8fa7962a78c8?q=80&w=1600&auto=format&fit=crop" alt="baner" className="w-full h-full object-cover"/>
          </div>
        </div>
      </section>

      {/* Filters */}
      <section className="border-t bg-white/60 backdrop-blur">
        <div className="max-w-7xl mx-auto px-4 py-5 flex flex-wrap items-center gap-3" id="catalog">
          <div className="relative md:hidden w-full">
            <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2"/>
            <Input value={query} onChange={(e)=>setQuery(e.target.value)} placeholder="Szukaj po nazwie, marce, nutach..." className="pl-9 rounded-full"/>
          </div>

          <div className="flex items-center gap-2"><Filter className="w-4 h-4"/> Filtry:</div>
          <Select value={gender} onValueChange={setGender}>
            <SelectTrigger className="w-[160px]"><SelectValue placeholder="Płeć"/></SelectTrigger>
            <SelectContent>
              {['wszyscy','męskie','damskie','unisex'].map(v=> <SelectItem key={v} value={v}>{v}</SelectItem>)}
            </SelectContent>
          </Select>

          <Select value={brand} onValueChange={setBrand}>
            <SelectTrigger className="w-[180px]"><SelectValue placeholder="Marka"/></SelectTrigger>
            <SelectContent>
              {brands.map(v=> <SelectItem key={v} value={v}>{v}</SelectItem>)}
            </SelectContent>
          </Select>

          <Select value={family} onValueChange={setFamily}>
            <SelectTrigger className="w-[220px]"><SelectValue placeholder="Rodzina zapachowa"/></SelectTrigger>
            <SelectContent>
              {families.map(v=> <SelectItem key={v} value={v}>{v}</SelectItem>)}
            </SelectContent>
          </Select>

          <div className="flex items-center gap-3 ml-auto">
            <label className="text-sm text-muted-foreground">Maks. cena: {formatPLN(priceMax)}</label>
            <input type="range" min={100} max={1500} step={10} value={priceMax} onChange={(e)=>setPriceMax(Number(e.target.value))} />
            <Select value={sort} onValueChange={setSort}>
              <SelectTrigger className="w-[170px]"><SelectValue placeholder="Sortowanie"/></SelectTrigger>
              <SelectContent>
                <SelectItem value="popular">Popularność</SelectItem>
                <SelectItem value="price-asc">Cena rosnąco</SelectItem>
                <SelectItem value="price-desc">Cena malejąco</SelectItem>
                <SelectItem value="rating">Ocena</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>
      </section>

      {/* Catalog */}
      <main className="max-w-7xl mx-auto px-4 py-8">
        <div className="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          <AnimatePresence>
            {filtered.map(p => (
              <ProductCard key={p.id} p={p} />
            ))}
          </AnimatePresence>
        </div>
      </main>

      {/* Quick view dialog */}
      <Dialog open={!!quickView} onOpenChange={(o)=>!o&&setQuickView(null)}>
        <DialogContent className="max-w-3xl">
          {quickView && (
            <div className="grid md:grid-cols-2 gap-6">
              <div className="rounded-2xl overflow-hidden">
                <img src={quickView.image} alt={quickView.name} className="w-full h-full object-cover"/>
              </div>
              <div className="space-y-3">
                <DialogHeader>
                  <DialogTitle className="text-2xl">{quickView.name}</DialogTitle>
                </DialogHeader>
                <div className="text-sm text-muted-foreground">{quickView.brand} • {quickView.gender} • {quickView.family}</div>
                <div className="flex items-center gap-1 text-sm"><Star className="w-4 h-4"/> {quickView.rating} / 5</div>
                <div className="text-sm">Nuty: {quickView.notes.join(", ")}</div>
                <div className="pt-2 grid grid-cols-[auto,1fr] items-center gap-3">
                  <span className="text-sm">Pojemność:</span>
                  <div className="flex flex-wrap gap-2">
                    {quickView.ml.map(m => (
                      <Button key={m} variant="outline" size="sm" onClick={()=>addToCart(quickView, m)}> {m} ml – {formatPLN(quickView.price * (m / quickView.ml[0]))}</Button>
                    ))}
                  </div>
                </div>
                <div className="text-xs text-muted-foreground pt-2">* Produkt demo. Płatności i wysyłka są zasymulowane.</div>
              </div>
            </div>
          )}
          <DialogFooter>
            <Button variant="outline" onClick={()=>setQuickView(null)}>Zamknij</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Checkout dialog */}
      <Dialog open={checkoutOpen} onOpenChange={setCheckoutOpen}>
        <DialogContent className="max-w-xl">
          <DialogHeader>
            <DialogTitle>Finalizacja zamówienia</DialogTitle>
          </DialogHeader>
          <div className="grid gap-3">
            <Input placeholder="Imię i nazwisko" value={customer.name} onChange={(e)=>setCustomer({...customer, name:e.target.value})}/>
            <Input placeholder="E-mail" type="email" value={customer.email} onChange={(e)=>setCustomer({...customer, email:e.target.value})}/>
            <Input placeholder="Ulica i numer" value={customer.address} onChange={(e)=>setCustomer({...customer, address:e.target.value})}/>
            <div className="grid grid-cols-2 gap-3">
              <Input placeholder="Miasto" value={customer.city} onChange={(e)=>setCustomer({...customer, city:e.target.value})}/>
              <Input placeholder="Kod pocztowy" value={customer.zip} onChange={(e)=>setCustomer({...customer, zip:e.target.value})}/>
            </div>
            <div className="border rounded-xl p-3 space-y-2 bg-slate-50">
              {cart.map(i => (
                <div key={i.key} className="flex justify-between text-sm">
                  <span>{i.name} • {i.sizeMl} ml × {i.qty}</span>
                  <span>{formatPLN(i.price * i.qty)}</span>
                </div>
              ))}
              <div className="flex justify-between text-sm text-muted-foreground"><span>Dostawa</span><span>{cartTotal>500?"0,00 zł":formatPLN(15)}</span></div>
              <div className="flex justify-between font-semibold"><span>Do zapłaty</span><span>{formatPLN(cartTotal + (cartTotal>500?0:15))}</span></div>
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={()=>setCheckoutOpen(false)}>Wróć</Button>
            <Button onClick={placeOrder} disabled={!cart.length}>Zamawiam i płacę (demo)</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Footer */}
      <footer className="border-t mt-10">
        <div className="max-w-7xl mx-auto px-4 py-10 grid md:grid-cols-4 gap-8 text-sm">
          <div>
            <div className="font-semibold mb-2">Elegant Scents</div>
            <p className="text-muted-foreground">Perfumeria online – wyselekcjonowane zapachy, szybkie zakupy, pełna przejrzystość.</p>
          </div>
          <div>
            <div className="font-semibold mb-2">Informacje</div>
            <ul className="space-y-1 text-muted-foreground">
              <li>Regulamin</li>
              <li>Polityka prywatności</li>
              <li>Dostawa i zwroty</li>
            </ul>
          </div>
          <div>
            <div className="font-semibold mb-2">Pomoc</div>
            <ul className="space-y-1 text-muted-foreground">
              <li>Kontakt</li>
              <li>FAQ</li>
              <li>Status zamówienia</li>
            </ul>
          </div>
          <div>
            <div className="font-semibold mb-2">Newsletter</div>
            <div className="flex gap-2">
              <Input placeholder="Twój e-mail"/>
              <Button>Zapisz</Button>
            </div>
          </div>
        </div>
        <div className="text-xs text-muted-foreground text-center pb-6">© {new Date().getFullYear()} Elegant Scents. Projekt demo.</div>
      </footer>
    </div>
  );
}
